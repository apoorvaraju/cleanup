<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>ID Selector</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
  <script src='https://unpkg.com/mithril'></script>
  <style>
    .header { color: indianred; margin-top: 0.25em; }
    .company_name { color: gray; }
  </style>
</head>

<body>
  
  <div class="container-fluid">
    <div class="col-12">
      <div class="row">
        <div id='arena'></div>
      </div>
    </div>
  </div>

  <script>

    const host = location.host

    const Store = {
      ids: null,
      fetchIds: function () {
        m.request(`http://${host}/ids`)   // `http://localhost:3000/ids`
          .then(function (data) {
            Store.ids = data
          })
      },
      setId: function(id, selected_id) {
        let newrec = Store.ids.find(function (rec) {
          return rec.id == id
        })
        // console.log('newrec', JSON.stringify(newrec, 0, 2));
        if (newrec) {
          if (newrec.selected == selected_id) {
            delete newrec.selected
          } else {
            newrec['selected'] = selected_id
          }
          m.request({
            method: 'put',
            url: `http://${host}/ids/${id}`,
            data: newrec
          }).then(function (data) {
            m.redraw()
          })
        } else {
          alert("Couldn't find company with id: " + id)
        }
      }
    }

    const CompanyListing = {
      handleIdSelection: function(recid, refid) {
        return function() {
          Store.setId(recid, refid)
        }
      },
      view: function (vnode) {
        let ids = vnode.attrs.ids
        return m('table.table.table-bordered',
          ids.map(function (rec) {
            return m('tr',
              m('td.company_name', rec.name),
              m('td',
                rec.refs.map(function (ref) {
                  var current = (rec.selected == ref.id) ? 'btn-primary' : 'btn-outline-info'
                  return [
                    m(`button.btn.btn-sm.${current}`,
                      {onclick: CompanyListing.handleIdSelection(rec.id, ref.id),},
                      `${ref.id} (${ref.count})`),
                    m.trust(' &nbsp; ')
                  ]
                })))
          })
        )
      }
    }

    const App = {
      oncreate: Store.fetchIds,
      view() {
        return (Store.ids)
        ? [
            m('h4.header', 'Company ID selector'),
            m(CompanyListing, {
              ids: Store.ids
            })
          ]
        : [
            m('p.header', 'Loading ...'),
            m('hr'),
            m('p.small', 'Company ID selector. Mithril ' + m.version)
          ]
      }
    }

    const app = m.mount(document.getElementById('arena'), App)
  </script>
</body>

</html>